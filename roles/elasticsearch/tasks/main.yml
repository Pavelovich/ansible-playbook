---
- name: Add ElasticSearch apt key
  apt_key: id=D88E42B4 url=http://packages.elasticsearch.org/GPG-KEY-elasticsearch

- name: Add ElasticSearch apt repository
  apt_repository: repo='deb http://packages.elasticsearch.org/elasticsearch/0.90/debian stable main'

- name: Install ElasticSearch
  apt: pkg=elasticsearch

- name: Set ElasticSearch heap size to 256m
  lineinfile: dest=/etc/init.d/elasticsearch
              regexp='^ES_HEAP_SIZE\='
              insertafter='^#ES_HEAP_SIZE\=2g$'
              line='ES_HEAP_SIZE=256m'

- name: Enable mlockall in ElasticSearch
  lineinfile: >
                dest=/etc/elasticsearch/elasticsearch.yml
                regexp='^bootstrap\.mlockall:'
                insertafter='^# bootstrap\.mlockall: true$'
                line='bootstrap.mlockall: true'

- name: Disable index autocreation in ElasticSearch
  lineinfile: >
                dest=/etc/elasticsearch/elasticsearch.yml
                regexp='^action\.auto_create_index:'
                line='action.auto_create_index: false'

- name: Set firewall rule
  command: ufw allow from 192.184.92.154 to any port 9300
  register: ufw_result
  changed_when: "ufw_result.stdout.startswith('Rule')"

